-- models/intermediate/order/int_sales_order.sql

WITH SALES_PRODUCT AS (
    SELECT DISTINCT
        SALESORDERID,
        PRODUCTID
    FROM
        {{ ref('int_sales_detail') }}
),
SALES_ORDER AS (
    SELECT 
        ORDERS.SALESORDERID, 
        ORDERS.REVISIONNUMBER, 
        CAST(ORDERS.ORDERDATE AS DATE) AS ORDERDATE, 
        CAST(ORDERS.DUEDATE AS DATE) AS DUEDATE, 
        CAST(ORDERS.SHIPDATE AS DATE) AS SHIPDATE,
        ORDERS.STATUS AS STATUSID, 
        ORDERS.ONLINEORDERFLAG, 
        CAST(ORDERS.PURCHASEORDERNUMBER AS VARCHAR(15)) AS PURCHASEORDERNUMBER, 
        CAST(ORDERS.ACCOUNTNUMBER AS VARCHAR(15)) AS ACCOUNTNUMBER, 
        ORDERS.CUSTOMERID, 
        ORDERS.SALESPERSONID, 
        ORDERS.TERRITORYID, 
        ORDERS.BILLTOADDRESSID, 
        ORDERS.SHIPTOADDRESSID, 
        ORDERS.SHIPMETHODID, 
        ORDERS.CREDITCARDID, 
        CAST(ORDERS.CREDITCARDAPPROVALCODE AS VARCHAR(17)) AS CREDITCARDAPPROVALCODE, 
        ORDERS.CURRENCYRATEID, 
        ORDERS.SUBTOTAL, 
        ORDERS.TAXAMT, 
        ORDERS.FREIGHT, 
        ORDERS.TOTALDUE, 
        -- COMMENT, --CAMPO DESCARTADO, SOMENTE CONTÃ‰M VALORES NULOS 
        CAST(ORDERS.ROWGUID AS VARCHAR(38)) AS ROWGUID, 
        CAST(ORDERS.MODIFIEDDATE AS DATE) AS MODIFIEDDATE,
        SALES_PRODUCT.PRODUCTID 
    FROM 
        {{ ref('stg_adventure_works__salesorderheader') }} ORDERS
    LEFT JOIN SALES_PRODUCT
        ON SALES_PRODUCT.SALESORDERID = ORDERS.SALESORDERID
)

SELECT * FROM SALES_ORDER