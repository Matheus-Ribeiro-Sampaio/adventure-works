-- models/intermediate/order/int_sales_order.sql

WITH SALES_REASON AS (
    SELECT DISTINCT
        SALESORDERID,
        SALESREASONID
    FROM
        {{ ref('int_sales_reason') }} 
),
SALES_DETAIL AS (
    SELECT 
        SALESORDERID,
        PRODUCTID, 
        SALESORDERDETAILID,
        ORDERQTY, 
        UNITPRICE, 
        UNITPRICEDISCOUNT
    FROM
        {{ ref('int_sales_detail') }} 
),
SALES_ORDER AS (
    SELECT 
        SALES_ORDER.SALESORDERID, 
        SALES_ORDER.REVISIONNUMBER, 
        CAST(SALES_ORDER.ORDERDATE AS DATE) AS ORDERDATE,
        TO_NUMBER(TO_CHAR(SALES_ORDER.ORDERDATE::DATE, 'YYYYMMDD')) AS ORDERDATEID,
        CAST(SALES_ORDER.DUEDATE AS DATE) AS DUEDATE, 
        CAST(SALES_ORDER.SHIPDATE AS DATE) AS SHIPDATE,
        SALES_ORDER.STATUS AS STATUSID, 
        SALES_ORDER.ONLINEORDERFLAG, 
        CAST(SALES_ORDER.PURCHASEORDERNUMBER AS VARCHAR(15)) AS PURCHASEORDERNUMBER, 
        CAST(SALES_ORDER.ACCOUNTNUMBER AS VARCHAR(15)) AS ACCOUNTNUMBER, 
        SALES_ORDER.CUSTOMERID, 
        SALES_ORDER.SALESPERSONID, 
        SALES_ORDER.TERRITORYID, 
        SALES_ORDER.BILLTOADDRESSID, 
        SALES_ORDER.SHIPTOADDRESSID, 
        SALES_ORDER.SHIPMETHODID, 
        SALES_ORDER.CREDITCARDID, 
        CAST(SALES_ORDER.CREDITCARDAPPROVALCODE AS VARCHAR(17)) AS CREDITCARDAPPROVALCODE, 
        SALES_ORDER.CURRENCYRATEID, 
        SALES_ORDER.SUBTOTAL, 
        SALES_ORDER.TAXAMT, 
        SALES_ORDER.FREIGHT, 
        SALES_ORDER.TOTALDUE, 
        -- COMMENT, --CAMPO DESCARTADO, SOMENTE CONTÃ‰M VALORES NULOS 
        CAST(SALES_ORDER.ROWGUID AS VARCHAR(38)) AS ROWGUID, 
        CAST(SALES_ORDER.MODIFIEDDATE AS DATE) AS MODIFIEDDATE,
        SALES_DETAIL.PRODUCTID,
        SALES_REASON.SALESREASONID,
        SALES_DETAIL.SALESORDERDETAILID,
        SALES_DETAIL.ORDERQTY, 
        SALES_DETAIL.UNITPRICE, 
        SALES_DETAIL.UNITPRICEDISCOUNT
    FROM 
        {{ ref('stg_adventure_works__salesorderheader') }} SALES_ORDER
    LEFT JOIN SALES_REASON
        ON SALES_REASON.SALESORDERID = SALES_ORDER.SALESORDERID
    LEFT JOIN SALES_DETAIL
        ON SALES_DETAIL.SALESORDERID = SALES_ORDER.SALESORDERID
)

SELECT * FROM SALES_ORDER