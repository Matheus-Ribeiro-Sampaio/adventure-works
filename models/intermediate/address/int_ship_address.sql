-- models/intermediate/address/int_ship_address.sql

WITH COUNTRYREGION AS (
    SELECT 
        COUNTRYREGIONCODE, 
        CAST(NAME AS VARCHAR(80)) AS COUNTRY_REGION, 
        CAST(MODIFIEDDATE AS DATE) AS MODIFIEDDATECOUNTRYREGION 
    FROM 
        {{ ref('stg_adventure_works__countryregion') }}
),

STATEPROVINCE AS (
    SELECT 
        CAST(STATEPROVINCEID AS NUMBER(5)) AS STATEPROVINCEID, 
        CAST(STATEPROVINCECODE AS VARCHAR(3)) AS STATEPROVINCECODE, 
        COUNTRYREGIONCODE, 
        ISONLYSTATEPROVINCEFLAG, 
        CAST(NAME AS VARCHAR(80)) AS STATE_PROVINCE, 
        --TERRITORYID, --CAMPO DESCARTADO, CONTÉM IDS E NÃO SERÁ CONTEMPLADO EM DIMENSÃO  
        CAST(ROWGUID AS VARCHAR(38)) AS ROWGUIDSTATEPROVINCE, 
        CAST(MODIFIEDDATE AS DATE) AS MODIFIEDDATESTATEPROVINCE
    FROM 
        {{ ref('stg_adventure_works__stateprovince') }}
),

SHIP_ADDRESS AS (
    SELECT 
        ADDRESS.ADDRESSID AS SHIPTOADDRESSID, 
        CAST(ADDRESS.ADDRESSLINE1 AS VARCHAR(150)) AS ADDRESSLINE1, 
        CAST(ADDRESS.ADDRESSLINE2 AS VARCHAR(150)) AS ADDRESSLINE2, 
        CAST(ADDRESS.CITY AS VARCHAR(80)) AS CITY, 
        ADDRESS.STATEPROVINCEID, 
        CAST(ADDRESS.POSTALCODE AS VARCHAR(12)) AS POSTALCODE, 
        CAST(ADDRESS.SPATIALLOCATION AS VARCHAR(50)) AS SPATIALLOCATION, 
        CAST(ADDRESS.ROWGUID AS VARCHAR(38)) AS ROWGUIDADDRESS, 
        CAST(ADDRESS.MODIFIEDDATE AS DATE) AS MODIFIEDDATEADDRESS,
        STATEPROVINCE.STATEPROVINCECODE, 
        STATEPROVINCE.COUNTRYREGIONCODE, 
        STATEPROVINCE.ISONLYSTATEPROVINCEFLAG, 
        STATEPROVINCE.STATE_PROVINCE, 
        STATEPROVINCE.ROWGUIDSTATEPROVINCE, 
        STATEPROVINCE.MODIFIEDDATESTATEPROVINCE,
        COUNTRYREGION.COUNTRY_REGION, 
        COUNTRYREGION.MODIFIEDDATECOUNTRYREGION
    FROM 
        {{ ref('stg_adventure_works__address') }} AS ADDRESS
    INNER JOIN {{ ref('int_sales_order') }} AS SALES_ORDER
        ON SALES_ORDER.SHIPTOADDRESSID = ADDRESS.ADDRESSID
    LEFT JOIN STATEPROVINCE
        ON STATEPROVINCE.STATEPROVINCEID = ADDRESS.STATEPROVINCEID
    LEFT JOIN COUNTRYREGION
        ON COUNTRYREGION.COUNTRYREGIONCODE = STATEPROVINCE.COUNTRYREGIONCODE
)

SELECT * FROM SHIP_ADDRESS