-- models/intermediate/address/int_ship_address.sql

WITH COUNTRY_REGION AS (
    SELECT 
        COUNTRYREGIONCODE, 
        CAST(NAME AS VARCHAR(80)) AS COUNTRY_REGION, 
        CAST(MODIFIEDDATE AS DATE) AS MODIFIEDDATECOUNTRYREGION 
    FROM 
        {{ ref('stg_adventure_works__countryregion') }}
),

STATE_PROVINCE AS (
    SELECT 
        CAST(STATEPROVINCEID AS NUMBER(5)) AS STATEPROVINCEID, 
        CAST(STATEPROVINCECODE AS VARCHAR(3)) AS STATEPROVINCECODE, 
        COUNTRYREGIONCODE, 
        ISONLYSTATEPROVINCEFLAG, 
        CAST(NAME AS VARCHAR(80)) AS STATE_PROVINCE, 
        --TERRITORYID, --CAMPO DESCARTADO, CONTÉM IDS E NÃO SERÁ CONTEMPLADO EM DIMENSÃO  
        CAST(ROWGUID AS VARCHAR(38)) AS ROWGUIDSTATEPROVINCE, 
        CAST(MODIFIEDDATE AS DATE) AS MODIFIEDDATESTATEPROVINCE
    FROM 
        {{ ref('stg_adventure_works__stateprovince') }}
),

SHIP_ADDRESS AS (
    SELECT DISTINCT
        ADDRESS.ADDRESSID AS SHIPTOADDRESSID, 
        CAST(ADDRESS.ADDRESSLINE1 AS VARCHAR(150)) AS ADDRESSLINE1, 
        CAST(ADDRESS.ADDRESSLINE2 AS VARCHAR(150)) AS ADDRESSLINE2, 
        CAST(ADDRESS.CITY AS VARCHAR(80)) AS CITY, 
        ADDRESS.STATEPROVINCEID, 
        CAST(ADDRESS.POSTALCODE AS VARCHAR(12)) AS POSTALCODE, 
        CAST(ADDRESS.SPATIALLOCATION AS VARCHAR(50)) AS SPATIALLOCATION, 
        CAST(ADDRESS.ROWGUID AS VARCHAR(38)) AS ROWGUIDADDRESS, 
        CAST(ADDRESS.MODIFIEDDATE AS DATE) AS MODIFIEDDATEADDRESS,
        STATE_PROVINCE.STATEPROVINCECODE, 
        STATE_PROVINCE.COUNTRYREGIONCODE, 
        STATE_PROVINCE.ISONLYSTATEPROVINCEFLAG, 
        STATE_PROVINCE.STATE_PROVINCE, 
        STATE_PROVINCE.ROWGUIDSTATEPROVINCE, 
        STATE_PROVINCE.MODIFIEDDATESTATEPROVINCE,
        COUNTRY_REGION.COUNTRY_REGION, 
        COUNTRY_REGION.MODIFIEDDATECOUNTRYREGION
    FROM 
        {{ ref('int_sales_order') }} AS SALES_ORDER
    INNER JOIN {{ ref('stg_adventure_works__address') }} AS ADDRESS
        ON ADDRESS.ADDRESSID = SALES_ORDER.SHIPTOADDRESSID
    LEFT JOIN STATE_PROVINCE
        ON STATE_PROVINCE.STATEPROVINCEID = ADDRESS.STATEPROVINCEID
    LEFT JOIN COUNTRY_REGION
        ON COUNTRY_REGION.COUNTRYREGIONCODE = STATE_PROVINCE.COUNTRYREGIONCODE
)

SELECT * FROM SHIP_ADDRESS